{% extends 'base/base_nav_footer.html' %}

{% load static %}

{% block link %}    
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css"/>
<link rel="stylesheet" href="{% static "css/styles27052017.css" %}">
{% endblock link %}

{% block content %}
<div class="container-fluid">
  <div>
    <select class="custom-select" id=""></select>
    <button id="random" class="btn btn-primary">Hecho</button>

  </div>
</div>
<div class="row container-fluid">
<div class="col-xs-12 col-md-4">
    <div class="chart-container" style="width:300px !important">
      <canvas id="nutChar"></canvas>
    </div>
  </div>
  <div class="col-xs-12 col-md-8">
    <div class="chart-container">
      <canvas id="quantity-bar"></canvas>
    </div>
  </div>
</div>
<div class="container-fluid">
  <div class="mt-2">      
    <table id="analytics-table" class="table table-kitchen table-straped table-hover">
      <thead class="thead-inverse">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
        </tr>
      </thead>  
      <tbody>
        {% for cartridge in today_sold_product %}
        <tr>
          <td>
            <span>
              {{ cartridge.name }}
            </span>
          </td>
          <td>
            <span class="badge badge-success">
              {{ cartridge.frequency }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}

{% block javascript %}
<script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.js"></script>

<script type="text/javascript">
  $(function() {   
    console.log('hola');
    let today_sold_product = JSON.parse("{{ today_sold_product | safe }}");
    console.log('flag');
    let ctx = document.getElementById("nutChar").getContext('2d');
    let bar_ctx = document.getElementById("quantity-bar").getContext('2d');
    let category_sold = JSON.parse("{{ category_sold | safe }}");

    /** 
    * Gets the csrf cookie from cache
    */ 
    function get_cookie(name) {
      let cookie_value = null;
      if (document.cookie && document.cookie !== '') {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          let cookie = jQuery.trim(cookies[i]);
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookie_value = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookie_value;
    }

    function get_random_list(size){
      aux_list = [];
      for (let i = 0; i < size; i++) {
        aux_list[i] = parseInt(Math.random() * 10);
      }
      return aux_list;
    }

    function get_doughnut_labels(){
      let labels_list = [];
      console.log(today_sold_product);

      for (let i = 0 ; ; i++) {
        labels_list[i] = '{{ cartridge.name }}';
        i+=1;
      }

    }

    let nutChar = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: get_random_list(6),
          backgroundColor: [
          '#01579B',
          '#80CBC4',
          '#18FFFF',
          '#0097A7',
          '#4DB6AC',
          '#4FC3F7',
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        cutoutPercentage: 40, 
        animation: {
          animateScale: true,
        }
      }
    });

    let quantity_bar = new Chart(bar_ctx, {
      type: 'bar',
      data: {
        labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
        datasets: [{
          label: '# of Votes',
          data: [12, 19, 3, 5, 2, 3],
          backgroundColor: [
          'rgba(255, 99, 132, 0.2)',
          'rgba(54, 162, 235, 0.2)',
          'rgba(255, 206, 86, 0.2)',
          'rgba(75, 192, 192, 0.2)',
          'rgba(153, 102, 255, 0.2)',
          'rgba(255, 159, 64, 0.2)'
          ],
          borderColor: [
          'rgba(255,99,132,1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)',
          'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero:true
            }
          }]
        }
      }
    });

    $(this).on('click', '#random', function(event) {
      $.ajax({
        url: "{% url 'products:analytics' %}",
        type: 'POST',
        datatype: 'jsonp',
        traditional: true,
        data: {
          type: 'category',
          csrfmiddlewaretoken: get_cookie('csrftoken'),
        },
        success: function(result) {
          get_doughnut_labels()
          console.log(result);
          swal({
            title: 'Hecho',
            text: 'Categoría seleccionada',
            type: 'success',
            timer: 750,
            showConfirmButton: false,
          });
        },
        error: function(result) {
          swal({
            title: "Error",
            text: 'No se pudo generar la gráfica',
            type: "error",
            timer: 750,
            showConfirmButton: false,
          });
        },
      });
    });
  });
</script>
{% endblock javascript %}