{% extends "base/base_nav_footer.html" %}
{% load static %}
{% block link %}
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.3.8/sweetalert2.min.css">  
{% endblock link %}
{% block content %}

  <!-- Container -->
  <div class="container-fluid container-sales">
    <div class="row">
      <div class="group-sales col-xs-12 col-lg-12">
        <div class="row">
          <div class="col-xs-12 col-md-4 col-lg-4">
            <div class="card card-block card-product-title card-outline-info">
              <h3>Por comprar</h3>
            </div>
            <div class="card col-xs-12 card-scroll card-outline-info" id="group-provider">
              <div class="card-block products-block">
                {% for supplies in supply_list %}                  
                  {% if supplies.status == "PR"  %}
                    <div class="card-block product-container" id="supplies.supply-{{ supplies.supply.pk }}">
                      <h6 class="product-name">{{ supplies.supply.name }}</h6>
                      <img src="{{ supplies.supply.image.url }}" id="supplies.pr.supply-img-{{ supplies.pk }}" class="product-img-pr" width="200" height="200" draggable=true>
                      <h5 class="provider_unit" id="supplies.supply.quantity-{{ supplies.supply.measurement_quantity }},{{ supplies.supply.measurement_unit }}" > Unidad: {{ supplies.supply.measurement_quantity }} {{ supplies.supply.measurement_unit }} </h5>
                      <h5 class="provider_quantity" id="supplies.supply.quantity-{{ supplies.quantity }}" > Faltan: {{ supplies.quantity }} {{ supplies.supply.measurement_unit }} </h5>
                      <h5 class="provider_required" id="supplies.supply.quantity-{{ supplies.required_quantity }},{{ supplies.get_unit }}" > Comprar: {{ supplies.required_quantity }} {{ supplies.get_unit }} </h5>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>  
            </div>
          </div>
          <div class="col-xs-12 col-md-4 col-lg-4">
            <div class="card card-block card-product-title card-outline-info">
              <h3>En Almacen</h3>
            </div>
            <div class="card col-xs-12 card-scroll card-outline-info" id="group-stock">
              <div class="card-block products-block"> 
                {% for supplies in supply_list %}
                  {% if supplies.status == "ST" and supplies.quantity > 0 %}
                    <div class="card-block product-container" id="supplies.supply-{{ supplies.supply.pk }}">
                      <h6 class="product-name">{{ supplies.supply.name }}</h6>
                      <img src="{{ supplies.supply.image.url }}" id="supplies.pr.supply-img-{{ supplies.pk }}" class="product-img-pr" width="200" height="200" draggable=true>    
                      <h5 class="provider_quantity" id="supplies.supply.quantity-{{ supplies.quantity }}" > Cantidad: {{ supplies.quantity }} </h5>                      
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>          
          <div class="col-xs-12 col-md-4 col-lg-4">
            <div class="card card-block card-product-title card-outline-info">
              <h3>En uso</h3>
            </div>
            <div class="card col-xs-12 card-scroll card-outline-info" id="group-rfa">
              <div class="card-block products-block">
                {% for supplies in supply_list %}
                  {% if supplies.status == "AS" and supplies.quantity > 0 %}
                    <div class="card-block product-container" id="supplies.supply-{{ supplies.supply.pk }}">
                      <h6 class="product-name">{{ supplies.supply.name }}</h6>
                      <img src="{{ supplies.supply.image.url }}" id="supplies.pr.supply-img-{{ supplies.pk }}" class="product-img-pr" width="200" height="200" draggable=true>    
                      <h5 class="provider_quantity" id="supplies.supply.quantity-{{ supplies.quantity }}" > Cantidad: {{ supplies.quantity }} </h5>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>                                   
          </div>  
        </div>                          
      </div>      
    </div>
  </div>

{% endblock content %}
{% block javascript %}
<script type="text/javascript" charset="utf-8">

$(function(){

  function get_cookie(name) {
    let cookie_value = null;
    if (document.cookie && document.cookie !== '') {
      let cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let cookie = jQuery.trim(cookies[i]);
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookie_value = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookie_value;
  }

  let csrf_token = get_cookie('csrftoken');

  $("#group-stock,#group-rfa").on("dragover",function(e){
    e.preventDefault();
  });

  $(".product-img-pr").on("dragstart",function(e){    

    let element = $(this);
    let element_id = element.attr('id').substring(23);
    let element_unit = element.parent().children(".provider_unit").attr('id').substring(25);



    let element_quantity = element.parent().children(".provider_quantity").attr('id').substring(25);
    let str = element_id+","+element_quantity+","+element_unit;

    console.log(str);

    e.originalEvent.dataTransfer.setData("text", str);

  });

  $("#group-stock,#group-rfa ").on("drop",function(e){
    e.preventDefault();
    let data = e.originalEvent.dataTransfer.getData("text");
    let obj_wh = data.split(',');
    let obj_id = obj_wh[0];
    let obj_quantity = obj_wh[1];
    let obj_measurement = obj_wh[2];
    let obj_unit = obj_wh[3];

    let move = "Stock"
    let id = $(this).attr("id")
    if(id == "group-rfa"){
        move = "Assembly"
    }

    swal({
      title: '¿Cuantos ' +obj_unit+ ' desea mover? ',
      input: 'range',
      inputAttributes: {
        min: 1,
        max: obj_measurement * 5,
        step: 1
      },
      inputValue: Math.ceil((obj_measurement * 5) / 2),
      showCancelButton: true,
      confirmButtonText: 'Submit',
      showLoaderOnConfirm: true,
      preConfirm: function (number) {
        return new Promise(function (resolve, reject) {

          $.ajax({
            url: '{% url "products:wh_movements" %}',
            type: 'POST',
            data: {
              'type' : move,
              'cantidad' : number,
              'element_pk' : obj_id,
              csrfmiddlewaretoken: csrf_token,
            },
            traditional: true,
            success: function(result) {
              swal({
                title: "Éxito",
                text: "Listo",
                type: "success",
                showConfirmButton: false,
              });
              location.reload(true);
              setTimeout(rel, 1500);
            }
          });
        })
      },
      allowOutsideClick: false
    })
  });


});

</script>
  
{% endblock javascript %}