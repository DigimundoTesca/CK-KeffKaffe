{% extends "base/base_nav_footer.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row mt-3 mb-2">
        <div class="col-xs-12 col-md-6">
            <h2 class="text-xs-center">Producto popular de hoy:
                <span class="badge badge-info">{{ today_popular_cartridge.name }}
        </span>
            </h2>
        </div>
        <div class="col-xs-12 col-md-6">
            <h2 class="text-xs-center">Producto más popular:
                <span class="div badge badge-success">
          {{ always_popular_cartridge.name }}: {{ always_popular_cartridge.frequency }}
        </span>
            </h2>
        </div>
    </div>
    <div class="row mt-1">
        <div class="col-xs-12 col-xl-10 push-xl-1">
            <p class="text-align {% spaceless %}
      {% endspaceless %}">Costo total de insumos estimados: {{ estimated_total_cost }}</p>
            <table class="table table-kitchen table-striped table-hover" align="right">
                <thead class="thead-inverse">
                <tr>
                    <th>Nombre</th>
                    <th>Requeridos</th>
                    <th>Stock</th>
                    <th>Por Comprar</th>
                    <th>Proveedor</th>
                    <th>Cantidad x Unidad</th>
                    <th>Costo x Unidad</th>
                    <th>Costo Total</th>
                </tr>
                </thead>
                <tbody>
                {% for required in required_supplies %}
                {% if required.measurement_quantity == 1  %}
                {% if required.stock <= 50 %}
                <tr class="table-danger">
                    {% elif required.stock <= 25 %}
                <tr class="table-warning">
                    {% elif required.stock <= 10 %}
                <tr class="table-success">
                    {% endif %}
                    {% else %}
                    {% if required.stock <= 500 %}
                <tr class="table-danger">
                    {% elif required.stock <= 1000 %}
                <tr class="table-warning">
                    {% elif required.stock <= 2000 %}
                <tr class="table-success">
                    {% endif %}
                    {% endif %}
                    <td>{{ required.name }}</td>
                    <td>{{ required.quantity }} {{ required.measurement_unit }}</td>
                    <td>{{ required.stock }} {{ required.measurement_unit }}</td>
                    <td>{{ required.required }} {{ required.measurement_unit }}</td>
                    <td>{{ required.supplier }}</td>
                    <td>{{ required.supplier_quantity }} {{ required.supplier_unit }}</td>
                    <td>${{ required.cost }}</td>
                    <td>${{ required.full_cost }}</td>
                <tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class ="row col-xl-12 push-xl-1">
                <button id="btn-shop-list" class="btn btn-primary d-flex" data-toggle="modal" data-target="#ModalShopList">
                    <span class="btn-reports d-flex align-items-center"><i class="material-icons"></i>Crear Lista de Compras</span>
                </button>
                <button id="btn-save-ticket-csv" class="offset-md-7 btn btn-primary d-flex">
                    <span class="btn-reports d-flex align-items-center"><i class="material-icons">file_download</i>Generar Reporte</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ShopList Modal -->
<div class="modal fade" id="ModalShopList" tabindex="-1" role="dialog" >
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="ModalLabel">Lista de Compras</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid container-sales">
                    <div class="group-sales col-xs-6 col-md-6 col-lg-6">
                        <div class="card card-block card-product-title card-outline-info">
                            <h3>Por comprar</h3>
                        </div>
                        <div class="container-sales">
                            <div class="card card-scroll card-outline-info" id="group-provider">
                                <div class="card-block products-block">
                                    {% for supplies in supply_list %}
                                    <div class="card-block product-container" id="supplies.supply-{{ supplies.pk }}">
                                        <h7 class="product_name" id ="supply_name-{{ supplies.name }}" >{{ supplies.name }}</h7>
                                        <img src="{{ supplies.image.url }}" id="supplies.pr.supply-img-{{ supplies.pk }}" class="product-img-list" width="200" height="200" draggable=true>
                                        <h7 class="provider_unit" id="supplies.quantity-{{ supplies.self_measurement_conversion }},{{ supplies.self_unit_conversion }},{{ supplies.presentation_cost }}" > Unidad: {{ supplies.self_measurement_conversion }} {{ supplies.self_unit_conversion }} </h7>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="group-sales col-xs-6 col-md-6 col-lg-6">
                        <table class="table table-kitchen table-striped table-hover" align="right" id="TableID">
                            <thead class="thead-inverse">
                            <tbody>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Requeridos</th>
                                    <th>Medida</th>
                                    <th>Total</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-save-ticket_local-csv" class="offset-md-7 btn btn-primary d-flex">
                        <span class="btn-reports d-flex align-items-center"><i class="material-icons">file_download</i>Generar Reporte</span>
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    {% endblock content %}
    {% block javascript %}

    <script src="{% static 'js/papaparse.min.js' %}" defer></script>
    <script src="{% static 'js/blob.js' %}" defer></script>
    <script src="{% static 'js/fileSaver.min.js' %}" defer></script>
    <script type="text/javascript" charset="utf-8">

        $(function(){

            $(this).on('click', '#btn-save-ticket-csv' , function(event) {
                /**
                 * Convert JSON TO CSV
                 */
                var diners_json = null;

                $.ajax({
                    url: "{% url 'products:catering' %}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        type: 'buy_list',
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    beforeSend: function(){
                        swal({
                            title: "Generando Excel",
                            text: "Espere mientras obtenemos toda la información",
                        });
                        swal.enableLoading();
                    },
                    success: function(result, status, XHR) {

                        diner_details = Papa.unparse({
                            fields: ["Nombre", "Requeridos", "Stock", "Por Comprar", "Comprar en", "Cantidad x Unidad", "Costo x Unidad", "Costo Total"],
                            data: result.buy_list
                        });

                        var blob = new Blob([ diner_details ], {
                            type: "text/csv;charset=UTF-8" }
                        );

                        var datetime = new Date();
                        saveAs(blob, datetime + '.csv');

                        swal({
                            title: "Éxito",
                            text: "Datos obtenidos",
                            type: "info",
                            timer: 750,
                            showConfirmButton: false
                        }).then(
                            function(){},
                            function(dismiss){}
                        );
                    },
                    complete: function(result){
                        setTimeout(function() {
                        }, 750);
                    }
                });
            });

            $(this).on('click', '#btn-save-ticket_local-csv' , function(event) {
                swal({
                    title: "Generando Excel",
                    text: "Espere mientras obtenemos toda la información",
                });
                swal.enableLoading();

                diner_details = Papa.unparse({
                    fields: ["Nombre", "Por_Comprar", "Unidad", "Costo x Unidad", "Costo_Total"],
                    data: list_array
                });

                var blob = new Blob([ diner_details ], {
                    type: "text/csv;charset=UTF-8" }
                );

                var datetime = new Date();
                saveAs(blob, datetime + '.csv');

                swal({
                    title: "Éxito",
                    text: "Datos obtenidos",
                    type: "info",
                    timer: 750,
                    showConfirmButton: false
                }).then(
                    function(){},
                    function(dismiss){}
                );
            });


            var list_array = [];

            $(".product-img-list").on("click",function(e){

                var element = $(this);
                var product_name = element.parent().children(".product_name").attr('id').substring(12);
                var product_measurement = element.parent().children(".provider_unit").attr('id').substring(18);
                var obj_wh = product_measurement.split(',');
                var obj_unit = obj_wh[0];
                var obj_measurement = obj_wh[1];
                var obj_cost = obj_wh[2];

                var string = {
                    'Nombre': product_name,
                    'Por_Comprar': obj_unit,
                    'Unidad': obj_measurement,
                    'Costo x Unidad': obj_cost,
                    'Costo_Total': obj_cost
                };

                var html_list = "";

                if (list_array.length===0){
                    list_array.push(string);
                }else{
                    var igual = false;
                    for (i = 0; i < list_array.length; i++){
                       if (list_array[i].Nombre===product_name){
                           list_array[i].Por_Comprar = parseInt(list_array[i].Por_Comprar) + parseInt(obj_unit);
                           list_array[i].Costo_Total = parseInt(list_array[i].Costo_Total) + parseInt(obj_cost);
                           igual = true;
                       }
                    }
                    if(!igual){
                        list_array.push(string);
                    }
                }

                for (i = 0; i < list_array.length; i++) {
                    html_list +=
                        '<tr>' +
                            '<th>' + list_array[i].Nombre + '</th>' +
                            '<th>' + list_array[i].Por_Comprar + '</th>' +
                            '<th>' + list_array[i].Unidad + '</th>' +
                            '<th>' + list_array[i].Costo_Total + '$</th>' +
                        '</tr>'
                }

                $("#TableID tbody tr").remove();
                $("#TableID tbody")
                        .append($(
                            '<tr>'+
                                '<th>Nombre</th>'+
                                '<th>Requeridos</th>'+
                                '<th>Medida</th>'+
                                '<th>Total</th>'+
                            '</tr>'
                            + html_list
                        ));

            });


        });
    </script>
    {% endblock javascript %}
